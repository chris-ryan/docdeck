<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link type="text/css" href="../style.css" rel="stylesheet"/>
  <title>DiabCRE - Knowledgebase</title>
</head>

<body>

  <!-- Header -->
  <header class="header">
    <div class="top">
        <h1>Diab CRE Knowledgebase</h1>
    </div>
  </header>

<div class="left-navbar">
</div>

<div class="main-content"><p>The socket.io library abstracts websockets with fallbacks to support browsers that don&#39;t support websockets</p>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'exress'</span>);
<span class="hljs-keyword">var</span> app = express();
<span class="hljs-keyword">var</span> server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>).createServer(app);
<span class="hljs-keyword">var</span> io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>)(server);

io.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">client</span>) </span>{
    client.on(<span class="hljs-string">'join'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
        client.nickname = name;
    });
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Client connected...'</span>);
    <span class="hljs-comment">//emit the message event on the client</span>
    client.emit(<span class="hljs-string">'messages'</span>, {hello: <span class="hljs-string">'world'</span> });
    <span class="hljs-comment">//listen for message events</span>
    client.on(<span class="hljs-string">'messages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)</span>{
        <span class="hljs-keyword">var</span> nickname = client.nickname;
        <span class="hljs-comment">//broadcast message to all other clients</span>
        client.broadcast.emit(<span class="hljs-string">"messages"</span>, nickname + <span class="hljs-string">": "</span> + message);
        <span class="hljs-comment">//send the same mesasge back to client</span>
        client.emit(<span class="hljs-string">"messages"</span>, nickname + <span class="hljs-string">": "</span> + message);
    });
});

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    res.sendFile(__dirname + <span class="hljs-string">'/index.html'</span>);
});

server.listen(<span class="hljs-number">8080</span>);


<span class="hljs-keyword">in</span> the html you need to load the socket.io library and connect to the server...
</code></pre><script src="/socket.io/socket.io.js"></script>

<script>
    var server = io.connect('http://localhost:8080');
    server.on('connect', function(data) {
        $('#status').html('Connected to chattr');
        nickname = prompt("What is your nickname?");
        server.emit('join', nickname);
    });
</script>

<p><script>
    var socket = io.connect(<a href="http://localhost:8080">http://localhost:8080</a>&#39;);
    $(&#39;#chat_form&#39;).submit(function(e){
        var message = $(&#39;#chat_input&#39;).val();
        //emit messages event on the server
        socket.emit(&#39;messages&#39;, message);
    });</p>
<pre><code>socket.<span class="hljs-keyword">on</span>(<span class="hljs-string">'messages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> <span class="hljs-comment">{
    insertMessage(data);
}</span>);</span>
</code></pre><p></script></p>
<pre><code>Socket<span class="hljs-symbol">'s</span> broadcast <span class="hljs-keyword">property</span> allows us <span class="hljs-keyword">to</span> emit <span class="hljs-keyword">to</span> <span class="hljs-keyword">all</span> clients connected <span class="hljs-keyword">to</span> a server (such as <span class="hljs-keyword">in</span> the <span class="hljs-keyword">case</span> <span class="hljs-keyword">of</span> a chatroom).
```socket.broadcast.emit(<span class="hljs-string">"messsage"</span>, <span class="hljs-string">"Hello"</span>);
</code></pre><p>To configure a socket client within a JS app, instead of referencing socket.io.js in a <script> tag as above, we just need to 
<code>require (socket.io-client);</code></p>
<h3 id="persisting-data">Persisting data</h3>
<pre><code><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'exress'</span>);
<span class="hljs-keyword">var</span> app = express();
<span class="hljs-keyword">var</span> server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>).createServer(app);
<span class="hljs-keyword">var</span> io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>)(server);
<span class="hljs-keyword">var</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>);
<span class="hljs-keyword">var</span> redisClient = redis.createClient();
<span class="hljs-comment">// client.set("message1", "hello, this is Bob");</span>

<span class="hljs-keyword">var</span> messages = [];
<span class="hljs-keyword">var</span> storeMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name, data</span>)</span>{
    <span class="hljs-keyword">var</span> message = <span class="hljs-built_in">JSON</span>.stringify({name: name, data: data});
    <span class="hljs-comment">/*messages.push({name: name, data: data}); //add message to end of array
    if (messages.length &gt; 10) {
        messages.shift();
    }*/</span>
    redisClient.lpush(<span class="hljs-string">"messages"</span>, message, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, response</span>)</span>{
        redisClient.ltrim(<span class="hljs-string">"messages"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>);
    });
}

io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">client</span>) </span>{
    client.on(<span class="hljs-string">'messages'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
        client.get(<span class="hljs-string">"nickname"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, name</span>) </span>{
            client.broadcast.emit(<span class="hljs-string">"messages"</span>, name + <span class="hljs-string">": "</span> + message);
            client.emit(<span class="hljs-string">"messages"</span>, name + <span class="hljs-string">": "</span> + message);
            storeMessage(name, message);
        });
    });

    client.on(<span class="hljs-string">'join'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) </span>{
        redisClient.lrange(<span class="hljs-string">"messages"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, messages</span>)</span>{
            messages = messages.reverse();
            messages.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>)</span>{
                message = <span class="hljs-built_in">JSON</span>.parse(message);
                client.emit(<span class="hljs-string">"messages"</span>, message.name + <span class="hljs-string">": "</span> + message.data);
            });
        });

        <span class="hljs-comment">//notify other clients a chatter has joined</span>
        client.broadcast.emit(<span class="hljs-string">"add chatter"</span>, name);
        redisClient.smembers(<span class="hljs-string">'names'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, names</span>)</span>{
            names.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>)</span>{
                client.emit(<span class="hljs-string">'add chatter'</span>, name);
            });
        });
        redisClient.sadd(<span class="hljs-string">"chatters"</span>, name);
    });

    <span class="hljs-comment">//remove chatter when they disconnect</span>
    client.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>)</span>{
        client.get(<span class="hljs-string">'nickname'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, name</span>)</span>{
            client.broadcast.emit(<span class="hljs-string">"remove chatter"</span>, name);
            redisClient.srem(<span class="hljs-string">"chatters"</span>, name);
        });
    });
});

app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    res.sendFile(__dirname + <span class="hljs-string">'/index.html'</span>);
});

server.listen(<span class="hljs-number">8080</span>);
</code></pre><p>and in the html
```
socket.on(&#39;add chatter&#39;, function(name) {
    var chatter = $(&#39;<li>&#39;+ name + &#39;</li>&#39;).data(&#39;name&#39;, name);
    $(&#39;#chatters&#39;).append(chatter);
});</p>
<p>// remove client when they disconnect
server.on(&#39;remove chatter&#39;, fucntion(name) {
    $(&#39;#chatters li[data-name=&#39; + name + &#39;]&#39;).remove();
});</p>
</div></body></html>